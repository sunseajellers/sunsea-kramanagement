rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().isAdmin == true;
    }
    
    function isManager() {
      return isAuthenticated() && getUserData().role == 'manager';
    }
    
    function isManagerOrAdmin() {
      return isManager() || isAdmin();
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Authenticated users can read user profiles (needed for team lists, assignments)
      allow read: if isAuthenticated();
      
      // Users can create their own profile on signup
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.isAdmin == false; // Prevent self-promotion
      
      // Users can update their own basic info (avatar, name), but NOT role/isAdmin
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'role', 'uid', 'createdAt']);
      
      // Admins can update ANY field (including role and isAdmin)
      allow update: if isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // --- KRAs Collection ---
    match /kras/{kraId} {
      // Read: Assigned users, Owner, Managers, or Admins
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.assignedTo 
        || resource.data.ownerId == request.auth.uid
        || isManagerOrAdmin()
      );
      
      // Create: Authenticated users can create KRAs
      allow create: if isAuthenticated()
        && request.resource.data.ownerId == request.auth.uid;
      
      // Update: Owner, Admin, or Manager can update
      // Assigned users might update status (if you allow it), but let's restrict to owner/admin/manager for structure
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid 
        || isManagerOrAdmin()
      );
      
      // Delete: Owner or Admin
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid 
        || isAdmin()
      );
    }
    
    // --- Tasks Collection ---
    match /tasks/{taskId} {
      // Read: Assigned users (array), Creator, Managers, Admins
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.assignedTo 
        || resource.data.assignedBy == request.auth.uid
        || isManagerOrAdmin()
      );
      
      // Create: Authenticated users can create tasks
      allow create: if isAuthenticated()
        && request.resource.data.assignedBy == request.auth.uid;
      
      // Update: 
      // 1. Assigned users can update status/comments (but not reassign or change core details ideally, but for simplicity allowing update)
      // 2. Creator, Manager, Admin can update everything
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.assignedTo
        || resource.data.assignedBy == request.auth.uid
        || isManagerOrAdmin()
      );
      
      // Delete: Creator, Admin, Manager
      allow delete: if isAuthenticated() && (
        resource.data.assignedBy == request.auth.uid 
        || isManagerOrAdmin()
      );
    }
    
    // --- Teams Collection ---
    match /teams/{teamId} {
      // Read: All authenticated users (to see available teams)
      allow read: if isAuthenticated();
      
      // Create: Admins only
      allow create: if isAdmin();
      
      // Update: Team Manager or Admin
      allow update: if isAuthenticated() && (
        resource.data.managerId == request.auth.uid 
        || isAdmin()
      );
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Notifications Collection ---
    match /notifications/{notificationId} {
      // Read: Only the owner of the notification
      allow read: if isOwner(resource.data.userId);
      
      // Create: System/Backend usually creates these. 
      // If client creates them (e.g. on task assignment), allow authenticated.
      allow create: if isAuthenticated();
      
      // Update: Owner can mark as read
      allow update: if isOwner(resource.data.userId);
      
      // Delete: Owner can delete
      allow delete: if isOwner(resource.data.userId);
    }
    
    // --- Reports Collection ---
    match /reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isManagerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
