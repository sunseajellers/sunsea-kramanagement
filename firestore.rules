rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Simplified Helper Functions (avoid circular dependencies) ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isManager() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager';
    }

    function isManagerOrAdmin() {
      return isAdmin() || isManager();
    }

    function isAssigned(resource, field) {
      return isAuthenticated() && request.auth.uid in resource.data[field];
    }

    function isInTeam(teamId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Read: Users can read their own profile, admins can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin()
      );

      // Create: Users can create their own profile, admins can create any
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.isAdmin == false; // Prevent self-promotion

      // Update: Users can update their own basic info, admins can update everything
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'role', 'permissions', 'uid', 'createdAt'])) ||
        // Allow role/permission changes only if current user is admin
        (request.auth.uid != userId && isAdmin() &&
         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) ||
          (request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) &&
           ['admin', 'manager', 'employee'].hasAny(request.resource.data.role))))
      );

      // Delete: Only admins
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // --- KRAs Collection ---
    match /kras/{kraId} {
      // Read: Assigned users, owners, managers, admins
      allow read: if isAuthenticated() && (
        isAssigned(resource, 'assignedTo') ||
        resource.data.ownerId == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Create: Users can create their own KRAs, managers/admins can create any
      allow create: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Update: Owner, assigned users (limited), or managers/admins
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (isAssigned(resource, 'assignedTo') && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'ownerId', 'teamIds'])) ||
        isManagerOrAdmin()
      );

      // Delete: Owner or managers/admins
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // --- Tasks Collection ---
    match /tasks/{taskId} {
      // Read: Assigned users, creator, or managers/admins
      allow read: if isAuthenticated() && (
        isAssigned(resource, 'assignedTo') ||
        resource.data.assignedBy == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Create: Users can create tasks, managers/admins can create any
      allow create: if isAuthenticated() && (
        resource.data.assignedBy == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Update: Assigned users (limited updates), creator, or managers/admins
      allow update: if isAuthenticated() && (
        (isAssigned(resource, 'assignedTo') && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'assignedBy', 'dueDate'])) ||
        resource.data.assignedBy == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Delete: Creator or managers/admins
      allow delete: if isAuthenticated() && (
        resource.data.assignedBy == request.auth.uid ||
        isManagerOrAdmin()
      );
    }
    
    // --- Teams Collection ---
    match /teams/{teamId} {
      // Read: Team members, managers, admins
      allow read: if isAuthenticated() && (
        isInTeam(teamId) ||
        resource.data.managerId == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Create: Managers or admins
      allow create: if isManagerOrAdmin();

      // Update: Team manager or admins
      allow update: if isAuthenticated() && (
        resource.data.managerId == request.auth.uid ||
        isAdmin()
      );

      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Notification Rules Collection (Admin Only) ---
    match /notificationRules/{ruleId} {
      // Read: Managers or admins
      allow read: if isManagerOrAdmin();

      // Create: Managers or admins
      allow create: if isManagerOrAdmin();

      // Update: Managers or admins
      allow update: if isManagerOrAdmin();

      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Reports Collection ---
    match /reports/{reportId} {
      // Read: Report owner or managers/admins
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Create: System or authenticated users
      allow create: if isAuthenticated();

      // Update: Managers or admins
      allow update: if isManagerOrAdmin();

      // Delete: Managers or admins
      allow delete: if isManagerOrAdmin();
    }
    
    // --- Weekly Reports Collection ---
    match /weeklyReports/{reportId} {
      // Read: Report owner or managers/admins
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isManagerOrAdmin()
      );

      // Create: System or authenticated users
      allow create: if isAuthenticated();

      // Update: Managers or admins
      allow update: if isManagerOrAdmin();

      // Delete: Managers or admins
      allow delete: if isManagerOrAdmin();
    }
    
    // --- Team Weekly Reports Collection ---
    match /teamWeeklyReports/{reportId} {
      // Read: Team members, managers, admins
      allow read: if isAuthenticated() && (
        isInTeam(resource.data.teamId) ||
        isManagerOrAdmin()
      );

      // Create: System or authenticated users
      allow create: if isAuthenticated();

      // Update: Managers or admins
      allow update: if isManagerOrAdmin();

      // Delete: Managers or admins
      allow delete: if isManagerOrAdmin();
    }
    
    // --- Scoring Configuration Collection ---
    match /scoringConfig/{configId} {
      // Read: All authenticated users (to get scoring rules)
      allow read: if isAuthenticated();

      // Create: Managers or admins
      allow create: if isManagerOrAdmin();

      // Update: Managers or admins
      allow update: if isManagerOrAdmin();

      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Notifications Collection ---
    match /notifications/{notificationId} {
      // Read: Notification recipient or managers/admins
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isManagerOrAdmin()
      );
      
      // Create: System or authenticated users
      allow create: if isAuthenticated();
      
      // Update: Notification recipient (mark as read) or managers/admins
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isManagerOrAdmin()
      );
      
      // Delete: Notification recipient or managers/admins
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isManagerOrAdmin()
      );
    }
    
    // --- Admin Logs Collection ---
    match /admin_logs/{logId} {
      // Read: Managers or admins
      allow read: if isManagerOrAdmin();

      // Create: System or authenticated users
      allow create: if isAuthenticated();

      // Update: Admins only
      allow update: if isAdmin();

      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
