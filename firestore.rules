rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().isAdmin == true;
    }
    
    function isManager() {
      return isAuthenticated() && getUserData().role == 'manager';
    }
    
    function isManagerOrAdmin() {
      return isManager() || isAdmin();
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Authenticated users can read user profiles (needed for team lists, assignments)
      allow read: if isAuthenticated();
      
      // Users can create their own profile on signup
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.isAdmin == false; // Prevent self-promotion
      
      // Users can update their own basic info (avatar, name), but NOT role/isAdmin
      allow update: if isOwner(userId)
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'role', 'uid', 'createdAt']);
      
      // Admins can update ANY field (including role and isAdmin)
      allow update: if isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // --- KRAs Collection ---
    match /kras/{kraId} {
      // Read: Assigned users, Owner, Team members (if teamIds exist), Managers, or Admins
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.assignedTo 
        || resource.data.ownerId == request.auth.uid
        || (resource.data.teamIds != null && 
            resource.data.teamIds.hasAny([get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId]))
        || isManagerOrAdmin()
      );
      
      // Create: Authenticated users can create KRAs
      allow create: if isAuthenticated()
        && request.resource.data.ownerId == request.auth.uid;
      
      // Update: Owner, Team members (for team KRAs), Admin, or Manager can update
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid 
        || (resource.data.teamIds != null && 
            resource.data.teamIds.hasAny([get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId]))
        || isManagerOrAdmin()
      );
      
      // Delete: Owner or Admin
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid 
        || isAdmin()
      );
    }
    
    // --- Tasks Collection ---
    match /tasks/{taskId} {
      // Read: Assigned users (array), Creator, Managers, Admins
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.assignedTo 
        || resource.data.assignedBy == request.auth.uid
        || isManagerOrAdmin()
      );
      
      // Create: Authenticated users can create tasks
      allow create: if isAuthenticated()
        && request.resource.data.assignedBy == request.auth.uid;
      
      // Update: 
      // 1. Assigned users can update status/comments (but not reassign or change core details ideally, but for simplicity allowing update)
      // 2. Creator, Manager, Admin can update everything
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.assignedTo
        || resource.data.assignedBy == request.auth.uid
        || isManagerOrAdmin()
      );
      
      // Delete: Creator, Admin, Manager
      allow delete: if isAuthenticated() && (
        resource.data.assignedBy == request.auth.uid 
        || isManagerOrAdmin()
      );
    }
    
    // --- Teams Collection ---
    match /teams/{teamId} {
      // Read: All authenticated users (to see available teams)
      allow read: if isAuthenticated();
      
      // Create: Admins only
      allow create: if isAdmin();
      
      // Update: Team Manager or Admin
      allow update: if isAuthenticated() && (
        resource.data.managerId == request.auth.uid 
        || isAdmin()
      );
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Notification Rules Collection (Admin Only) ---
    match /notificationRules/{ruleId} {
      // Read: Admins only
      allow read: if isAdmin();
      
      // Create: Admins only
      allow create: if isAdmin();
      
      // Update: Admins only
      allow update: if isAdmin();
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Reports Collection ---
    match /reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isManagerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // --- Weekly Reports Collection ---
    match /weeklyReports/{reportId} {
      // Read: Report owner, Managers, Admins
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid 
        || isManagerOrAdmin()
      );
      
      // Create: System/Admin (for automated report generation)
      allow create: if isAuthenticated();
      
      // Update: Admins only
      allow update: if isAdmin();
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Team Weekly Reports Collection ---
    match /teamWeeklyReports/{reportId} {
      // Read: Team members, Managers, Admins
      allow read: if isAuthenticated() && (
        isManagerOrAdmin() ||
        (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
         get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.memberIds.hasAny([request.auth.uid]))
      );
      
      // Create: System/Admin
      allow create: if isAuthenticated();
      
      // Update: Admins only
      allow update: if isAdmin();
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Scoring Configuration Collection (Admin Only) ---
    match /scoringConfig/{configId} {
      // Read: All authenticated users (to get scoring rules)
      allow read: if isAuthenticated();
      
      // Create: Admins only
      allow create: if isAdmin();
      
      // Update: Admins only
      allow update: if isAdmin();
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // --- Analytics Data Collection (Admin Only) ---
    match /analytics/{analyticsId} {
      // Read: Admins only
      allow read: if isAdmin();
      
      // Create: System/Admin
      allow create: if isAuthenticated();
      
      // Update: Admins only
      allow update: if isAdmin();
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
