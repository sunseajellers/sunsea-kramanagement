rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Safe user data access - read user data for permission checks
    function getCurrentUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasPermission(permission) {
      let userData = getCurrentUserData();
      return isAuthenticated() && (
        userData.role == 'admin' ||
        userData.isAdmin == true ||
        (userData.permissions && permission in userData.permissions)
      );
    }

    function isAdmin() {
      let userData = getCurrentUserData();
      return isAuthenticated() && (userData.role == 'admin' || userData.isAdmin == true);
    }

    function isManager() {
      let userData = getCurrentUserData();
      return isAuthenticated() && userData.role == 'manager';
    }

    function isManagerOrAdmin() {
      return isManager() || isAdmin();
    }

    // Check if user is assigned to a task/KRA
    function isAssigned(resource, field) {
      return isAuthenticated() && request.auth.uid in resource.data[field];
    }

    // Check if user is in a team
    function isInTeam(teamId) {
      let userData = getCurrentUserData();
      return isAuthenticated() && userData.teamId == teamId;
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Read: Authenticated users can read their own profile and other users for team management
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || // Own profile
        isAuthenticated() // Allow reading other users for team/assignee lists
      );

      // Create: Users can create their own profile, admins can create any
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.isAdmin == false; // Prevent self-promotion

      // Update: Users can update their own basic info, admins can update everything
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'role', 'permissions', 'uid', 'createdAt'])) ||
        (isAuthenticated() && getCurrentUserData().isAdmin == true) // Allow admins to update
      );

      // Delete: Only admins
      allow delete: if isAuthenticated() && getCurrentUserData().isAdmin == true;
    }
    
    // --- KRAs Collection ---
    match /kras/{kraId} {
      // Read: Assigned users, owners, managers, admins, or users with view_kras permission
      allow read: if isAuthenticated() && (
        isAssigned(resource, 'assignedTo') ||
        resource.data.ownerId == request.auth.uid ||
        hasPermission('view_kras') ||
        isManagerOrAdmin()
      );

      // Create: Users with create_kras permission or managers/admins
      allow create: if isAuthenticated() && (
        hasPermission('create_kras') ||
        isManagerOrAdmin()
      ) && request.resource.data.ownerId == request.auth.uid;

      // Update: Owner, assigned users (limited), or users with update_kras permission
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (isAssigned(resource, 'assignedTo') && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'ownerId', 'teamIds'])) ||
        hasPermission('update_kras') ||
        isManagerOrAdmin()
      );

      // Delete: Owner or users with delete_kras permission
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        hasPermission('delete_kras') ||
        isAdmin()
      );
    }
    
    // --- Tasks Collection ---
    match /tasks/{taskId} {
      // Read: Assigned users, creator, or users with view_tasks permission
      allow read: if isAuthenticated() && (
        isAssigned(resource, 'assignedTo') ||
        resource.data.assignedBy == request.auth.uid ||
        hasPermission('view_tasks') ||
        isManagerOrAdmin()
      );

      // Create: Users with create_tasks permission or managers/admins
      allow create: if isAuthenticated() && (
        hasPermission('create_tasks') ||
        isManagerOrAdmin()
      ) && request.resource.data.assignedBy == request.auth.uid;

      // Update: Assigned users (limited updates), creator, or users with update_tasks permission
      allow update: if isAuthenticated() && (
        (isAssigned(resource, 'assignedTo') && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'assignedBy', 'dueDate'])) ||
        resource.data.assignedBy == request.auth.uid ||
        hasPermission('update_tasks') ||
        isManagerOrAdmin()
      );

      // Delete: Creator or users with delete_tasks permission
      allow delete: if isAuthenticated() && (
        resource.data.assignedBy == request.auth.uid ||
        hasPermission('delete_tasks') ||
        isManagerOrAdmin()
      );
    }
    
    // --- Teams Collection ---
    match /teams/{teamId} {
      // Read: Team members, managers, or users with view_teams permission
      allow read: if isAuthenticated() && (
        isInTeam(teamId) ||
        resource.data.managerId == request.auth.uid ||
        hasPermission('view_teams') ||
        isManagerOrAdmin()
      );

      // Create: Users with manage_teams permission or admins
      allow create: if hasPermission('manage_teams') || isAdmin();

      // Update: Team manager or users with manage_teams permission
      allow update: if isAuthenticated() && (
        resource.data.managerId == request.auth.uid ||
        hasPermission('manage_teams') ||
        isAdmin()
      );

      // Delete: Users with manage_teams permission or admins
      allow delete: if hasPermission('manage_teams') || isAdmin();
    }
    
    // --- Notification Rules Collection (Admin Only) ---
    match /notificationRules/{ruleId} {
      // Read: Users with manage_notifications permission or admins
      allow read: if hasPermission('manage_notifications') || isAdmin();

      // Create: Users with manage_notifications permission or admins
      allow create: if hasPermission('manage_notifications') || isAdmin();

      // Update: Users with manage_notifications permission or admins
      allow update: if hasPermission('manage_notifications') || isAdmin();

      // Delete: Users with manage_notifications permission or admins
      allow delete: if hasPermission('manage_notifications') || isAdmin();
    }
    
    // --- Reports Collection ---
    match /reports/{reportId} {
      // Read: Report owner or users with view_reports/generate_reports permission
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('view_reports') ||
        hasPermission('generate_reports') ||
        isManagerOrAdmin()
      );

      // Create: System or users with generate_reports permission
      allow create: if isAuthenticated() || hasPermission('generate_reports');

      // Update: Users with generate_reports permission or admins
      allow update: if hasPermission('generate_reports') || isAdmin();

      // Delete: Users with generate_reports permission or admins
      allow delete: if hasPermission('generate_reports') || isAdmin();
    }
    
    // --- Weekly Reports Collection ---
    match /weeklyReports/{reportId} {
      // Read: Report owner or users with view_reports/generate_reports permission
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('view_reports') ||
        hasPermission('generate_reports') ||
        isManagerOrAdmin()
      );

      // Create: System or users with generate_reports permission
      allow create: if isAuthenticated() || hasPermission('generate_reports');

      // Update: Users with generate_reports permission or admins
      allow update: if hasPermission('generate_reports') || isAdmin();

      // Delete: Users with generate_reports permission or admins
      allow delete: if hasPermission('generate_reports') || isAdmin();
    }
    
    // --- Team Weekly Reports Collection ---
    match /teamWeeklyReports/{reportId} {
      // Read: Team members, managers, or users with generate_reports permission
      allow read: if isAuthenticated() && (
        isInTeam(resource.data.teamId) ||
        hasPermission('generate_reports') ||
        isManagerOrAdmin()
      );

      // Create: System or users with generate_reports permission
      allow create: if isAuthenticated() || hasPermission('generate_reports');

      // Update: Users with generate_reports permission or admins
      allow update: if hasPermission('generate_reports') || isAdmin();

      // Delete: Users with generate_reports permission or admins
      allow delete: if hasPermission('generate_reports') || isAdmin();
    }
    
    // --- Scoring Configuration Collection ---
    match /scoringConfig/{configId} {
      // Read: All authenticated users (to get scoring rules)
      allow read: if isAuthenticated();

      // Create: Users with manage_scoring permission or admins
      allow create: if hasPermission('manage_scoring') || isAdmin();

      // Update: Users with manage_scoring permission or admins
      allow update: if hasPermission('manage_scoring') || isAdmin();

      // Delete: Users with manage_scoring permission or admins
      allow delete: if hasPermission('manage_scoring') || isAdmin();
    }
    
    // --- Notifications Collection ---
    match /notifications/{notificationId} {
      // Read: Notification recipient or users with view_notifications permission
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('view_notifications') ||
        isManagerOrAdmin()
      );
      
      // Create: System or users with manage_notifications permission
      allow create: if isAuthenticated() || hasPermission('manage_notifications');
      
      // Update: Notification recipient (mark as read) or users with manage_notifications permission
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('manage_notifications') ||
        isManagerOrAdmin()
      );
      
      // Delete: Notification recipient or users with manage_notifications permission
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasPermission('manage_notifications') ||
        isManagerOrAdmin()
      );
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
