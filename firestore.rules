rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // === RBAC HELPER FUNCTIONS ===

    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function getUserRoles(userId) {
      return get(/databases/$(database)/documents/userRoles/$(userId)).data;
    }

    function getRolePermissions(roleId) {
      return get(/databases/$(database)/documents/rolePermissions/$(roleId)).data.permissions;
    }

    function userHasPermission(userId, module, action) {
      let userRoles = getUserRoles(userId);
      let hasPermission = false;

      if (userRoles != null && userRoles.roleIds != null) {
        let roleIds = userRoles.roleIds;
        let i = 0;
        while (i < roleIds.size() && !hasPermission) {
          let rolePermissions = getRolePermissions(roleIds[i]);
          if (rolePermissions != null) {
            let j = 0;
            while (j < rolePermissions.size() && !hasPermission) {
              let permission = rolePermissions[j];
              if (permission.module == module && permission.action == action) {
                hasPermission = true;
              }
              j = j + 1;
            }
          }
          i = i + 1;
        }
      }

      return hasPermission;
    }

    function isOwner(userId, resource) {
      return resource.data.ownerId == userId ||
             resource.data.userId == userId ||
             resource.data.createdBy == userId ||
             resource.data.assignedBy == userId;
    }

    function isAssignedTo(userId, resource) {
      return userId in resource.data.assignedTo ||
             userId in resource.data.assignedUsers ||
             resource.data.assignedTo == userId;
    }

    function isInTeam(userId, teamId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return userDoc.data.teamId == teamId;
    }

    function isTeamMember(userId, resource) {
      return resource.data.teamId != null && isInTeam(userId, resource.data.teamId);
    }

    // === USERS COLLECTION ===
    match /users/{userId} {
      // Read: Users can read their own profile, admins can read all
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Create: Users can create their own profile during registration
      // Prevent legacy fields from being written
      allow create: if isAuthenticated() &&
        request.auth.uid == userId &&
        request.resource.data.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isAdmin', 'permissions']);

      // Update: Users can update their own basic info, admins can update everything
      // Prevent legacy fields from being written
      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      ) &&
      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isAdmin', 'permissions']);

      // Delete: Only admins
      allow delete: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    // === RBAC COLLECTIONS (Admin Only) ===
    match /roles/{roleId} {
      allow read, write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    match /permissions/{permissionId} {
      allow read, write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    match /rolePermissions/{roleId} {
      allow read, write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    match /userRoles/{userId} {
      allow read, write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    // === TEAMS COLLECTION ===
    match /teams/{teamId} {
      // Read: Team members and admins
      allow read: if isAuthenticated() && (
        isInTeam(request.auth.uid, teamId) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Write: Only admins
      allow write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    // === KRAS COLLECTION ===
    match /kras/{kraId} {
      // Read: Owner, assigned users, team members, or admins
      allow read: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        isAssignedTo(request.auth.uid, resource) ||
        isTeamMember(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Create: Authenticated users can create KRAs
      allow create: if isAuthenticated() &&
        isOwner(request.auth.uid, request.resource);

      // Update: Owner, assigned users (limited fields), or admins
      allow update: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        (isAssignedTo(request.auth.uid, resource) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'ownerId', 'teamId', 'createdAt', 'createdBy'])) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Delete: Owner or admins
      allow delete: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );
    }

    // === TASKS COLLECTION ===
    match /tasks/{taskId} {
      // Read: Creator, assigned users, team members, or admins
      allow read: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        isAssignedTo(request.auth.uid, resource) ||
        isTeamMember(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Create: Authenticated users can create tasks
      allow create: if isAuthenticated() &&
        isOwner(request.auth.uid, request.resource);

      // Update: Creator, assigned users (limited fields), or admins
      allow update: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        (isAssignedTo(request.auth.uid, resource) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['assignedTo', 'assignedBy', 'teamId', 'createdAt', 'createdBy'])) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Delete: Creator or admins
      allow delete: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );
    }

    // === REPORTS COLLECTIONS ===
    match /weeklyReports/{reportId} {
      // Read: Report owner or admins
      allow read: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Create: Report owner
      allow create: if isAuthenticated() &&
        isOwner(request.auth.uid, request.resource);

      // Update/Delete: Report owner or admins
      allow update, delete: if isAuthenticated() && (
        isOwner(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );
    }

    match /teamWeeklyReports/{reportId} {
      // Read: Team members or admins
      allow read: if isAuthenticated() && (
        isTeamMember(request.auth.uid, resource) ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Write: Only admins (team reports are generated by system/admin)
      allow write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    // === NOTIFICATIONS COLLECTION ===
    match /notifications/{notificationId} {
      // Read: Notification recipient or admins
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Create: System or admins
      allow create: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');

      // Update: Recipient (mark as read) or admins
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );

      // Delete: Recipient or admins
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );
    }

    // === COMMENTS COLLECTION ===
    match /comments/{commentId} {
      // Read: Task/KRA participants, team members, or admins
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/tasks/$(resource.data.taskId)) &&
        (isOwner(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))) ||
         isAssignedTo(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))) ||
         isTeamMember(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))) ||
         userHasPermission(request.auth.uid, 'admin', 'access')) ||
        exists(/databases/$(database)/documents/kras/$(resource.data.kraId)) &&
        (isOwner(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId))) ||
         isAssignedTo(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId))) ||
         isTeamMember(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId))) ||
         userHasPermission(request.auth.uid, 'admin', 'access'))
      );

      // Create: Task/KRA participants
      allow create: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        ((exists(/databases/$(database)/documents/tasks/$(resource.data.taskId)) &&
          (isOwner(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))) ||
           isAssignedTo(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))) ||
           isTeamMember(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))))) ||
         (exists(/databases/$(database)/documents/kras/$(resource.data.kraId)) &&
          (isOwner(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId))) ||
           isAssignedTo(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId))) ||
           isTeamMember(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId)))));

      // Update/Delete: Comment author or admins
      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        userHasPermission(request.auth.uid, 'admin', 'access')
      );
    }

    // === ACTIVITY LOGS COLLECTION ===
    match /activityLogs/{logId} {
      // Read: Related resource participants or admins
      allow read: if isAuthenticated() && (
        userHasPermission(request.auth.uid, 'admin', 'access') ||
        (resource.data.userId == request.auth.uid) ||
        (resource.data.taskId != null &&
         (isOwner(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))) ||
          isAssignedTo(request.auth.uid, get(/databases/$(database)/documents/tasks/$(resource.data.taskId))))) ||
        (resource.data.kraId != null &&
         (isOwner(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId))) ||
          isAssignedTo(request.auth.uid, get(/databases/$(database)/documents/kras/$(resource.data.kraId)))))
      );

      // Create: System or resource participants
      allow create: if isAuthenticated() &&
        (userHasPermission(request.auth.uid, 'admin', 'access') ||
         resource.data.userId == request.auth.uid);

      // No updates/deletes allowed
      allow update, delete: if false;
    }

    // === SYSTEM CONFIGURATION COLLECTIONS ===
    match /systemConfig/{configId} {
      allow read, write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    match /scoringConfig/{configId} {
      allow read, write: if isAuthenticated() &&
        userHasPermission(request.auth.uid, 'admin', 'access');
    }

    // === DEFAULT DENY ===
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
