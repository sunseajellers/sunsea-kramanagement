rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPERS
    // ========================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================
    // CORE COLLECTIONS
    // ========================================
    
    // Users: Users can read all (directory), update own profile. Admins can manage all.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // For signup
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Tasks: Collaborative. 
    // Ideally: Assignees can update status/progress. Admins can do all.
    // Current: Open to all authenticated for internal collaboration.
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
      match /checklist/{itemId} { allow read, write: if isAuthenticated(); }
      match /activityLog/{logId} { allow read, write: if isAuthenticated(); }
      match /comments/{commentId} { allow read, write: if isAuthenticated(); }
    }
    
    // Tickets: Collaborative.
    match /tickets/{ticketId} {
      allow read, write: if isAuthenticated();
      match /comments/{commentId} { allow read, write: if isAuthenticated(); }
    }
    
    // ========================================
    // ADMIN / CONFIG (PROTECTED)
    // ========================================
    
    // Departments & Teams - Managed by Admin/Strategies
    match /departments/{deptId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // System Config
    match /config/{docId} { 
      allow read: if isAuthenticated();
      allow write: if isAdmin(); 
    }
    
    match /scoringConfig/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // PERFORMANCE MODULES
    // ========================================
    match /kras/{kraId} { allow read, write: if isAuthenticated(); }
    match /kraTemplates/{templateId} { allow read, write: if isAuthenticated(); }
    match /kpis/{kpiId} { allow read, write: if isAuthenticated(); } 
    match /kpiTemplates/{templateId} { allow read, write: if isAuthenticated(); }
    match /objectives/{objId} { allow read, write: if isAuthenticated(); }
    match /keyResults/{krId} { allow read, write: if isAuthenticated(); }
    match /performanceScores/{scoreId} { allow read: if isAuthenticated(); allow write: if isAdmin(); } // Scores are system-generated
    match /performanceParameters/{paramId} { allow read: if isAuthenticated(); allow write: if isAdmin(); }

    // ========================================
    // KNOWLEDGE BASE
    // ========================================
    match /learningHub/{docId} { allow read, write: if isAuthenticated(); }
    match /articles/{articleId} { allow read, write: if isAuthenticated(); }
    match /categories/{catId} { allow read, write: if isAuthenticated(); }
    match /faqs/{faqId} { allow read, write: if isAuthenticated(); }

    // ========================================
    // LOGS & NOTIFICATIONS
    // ========================================
    match /notifications/{notifId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // For marking as read
    }

    match /activityLogs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Client-side logging allowed
      allow update, delete: if isAdmin(); // Audit logs should be immutable
    }
    
    match /taskUpdates/{updateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ========================================
    // MISC
    // ========================================
    match /holidays/{holidayId} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /scoringWeights/{weightId} { allow read: if isAuthenticated(); allow write: if isAdmin(); }
    match /taskRevisions/{revId} { allow read, write: if isAuthenticated(); }
    match /bulkTaskOperations/{opId} { allow read, write: if isAuthenticated(); }
    match /misReports/{reportId} { allow read, write: if isAuthenticated(); }
    
    // Catch-all
    match /{path=**} {
      allow read, write: if false; // Default deny for everything else
    }
  }
}
